---
- name: "Read public key for {{ client.name }}"
  slurp:
    src: "/etc/wireguard/keys/{{ client.name }}-public.key"
  register: client_public_key_file

- name: "Read private key for {{ client.name }}"
  slurp:
    src: "/etc/wireguard/keys/{{ client.name }}-private.key"
  register: client_private_key_file

- name: "Read pre-shared key for {{ client.name }}"
  slurp:
    src: "/etc/wireguard/keys/{{ client.name }}-psk.key"
  register: client_psk_file

- name: "Create configuration for {{ client.name }}"
  template:
    src: client.conf.j2
    dest: "/etc/wireguard/clients/{{ client.name }}.conf"
    mode: '0644'
    owner: root
    group: root
  vars:
    client_name: "{{ client.name }}"
    client_ip: "{{ client.ip }}"
    client_private_key: "{{ client_private_key_file.content | b64decode | trim }}"
    client_psk: "{{ client_psk_file.content | b64decode | trim }}"

- name: "Generate QR code for {{ client.name }}"
  shell: |
    qrencode -t ansiutf8 < /etc/wireguard/clients/{{ client.name }}.conf > /etc/wireguard/clients/{{ client.name }}-qr.txt
  args:
    creates: "/etc/wireguard/clients/{{ client.name }}-qr.txt"
