#!/bin/bash

# Script para facilitar la descarga de configuraciones de WireGuard
# Uso: ./download-configs.sh

echo "ğŸ”— Configuraciones de WireGuard disponibles:"
echo "=============================================="

CONFIG_DIR="{{ wireguard.config_dir }}"

# Mostrar configuraciones disponibles
echo "ğŸ“ Directorio de configuraciones: $CONFIG_DIR"
echo ""

if [ -d "$CONFIG_DIR" ]; then
    echo "ğŸ“‹ Archivos de configuraciÃ³n disponibles:"
    ls -la $CONFIG_DIR/peer*/ 2>/dev/null | grep -E '\.(conf|png)$' || echo "âš ï¸  No se encontraron configuraciones de peers"
    
    echo ""
    echo "ğŸŒ Para descargar desde tu mÃ¡quina local:"
    echo "=========================================="
    
    # Mostrar comandos para descargar configuraciones
    for peer_dir in $CONFIG_DIR/peer*/; do
        if [ -d "$peer_dir" ]; then
            peer_name=$(basename "$peer_dir")
            
            # ConfiguraciÃ³n para escritorio
            if [ -f "$peer_dir/$peer_name.conf" ]; then
                echo "ğŸ“± Peer $peer_name (archivo .conf):"
                echo "   scp -i ~/.ssh/vpn-server-key ubuntu@{{ ansible_facts['ec2_public_ipv4'] | default(hostvars[inventory_hostname]['ansible_host']) }}:$peer_dir$peer_name.conf ./"
            fi
            
            # QR Code para mÃ³vil
            if [ -f "$peer_dir/$peer_name.png" ]; then
                echo "ğŸ“± Peer $peer_name (QR Code):"
                echo "   scp -i ~/.ssh/vpn-server-key ubuntu@{{ ansible_facts['ec2_public_ipv4'] | default(hostvars[inventory_hostname]['ansible_host']) }}:$peer_dir$peer_name.png ./"
            fi
            echo ""
        fi
    done
    
    echo "ğŸŒ Servidor HTTP para descarga (puerto 8080):"
    echo "   http://{{ ansible_facts['ec2_public_ipv4'] | default(hostvars[inventory_hostname]['ansible_host']) }}:8080"
    echo ""
    echo "ğŸ“Š Estado del contenedor:"
    docker ps | grep wireguard
    
else
    echo "âŒ Directorio de configuraciones no encontrado"
fi
