name: ðŸ—‘ï¸ Destroy VPN Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'dev'
        type: string
      confirmation:
        description: 'Type DESTROY to confirm'
        required: true
        type: string

env:
  AWS_REGION: us-east-1

jobs:
  validate-and-destroy:
    name: ðŸ—‘ï¸ Validate and Destroy Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ‹ Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DESTROY" ]; then
            echo "âŒ ERROR: You must type exactly 'DESTROY' to confirm destruction"
            echo "   You typed: '${{ github.event.inputs.confirmation }}'"
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ” Get Backend Configuration from Parameter Store
        id: get_backend
        run: |
          # Try to get backend configuration from Parameter Store
          echo "ðŸ” Looking for backend configuration..."
          
          if aws ssm get-parameter --name "/vpn/${{ github.event.inputs.environment }}/backend-bucket" 2>/dev/null; then
            BACKEND_BUCKET=$(aws ssm get-parameter \
              --name "/vpn/${{ github.event.inputs.environment }}/backend-bucket" \
              --query 'Parameter.Value' \
              --output text)
            
            BACKEND_TABLE=$(aws ssm get-parameter \
              --name "/vpn/${{ github.event.inputs.environment }}/backend-table" \
              --query 'Parameter.Value' \
              --output text)
            
            echo "âœ… Found backend configuration:"
            echo "   ðŸª£ S3 Bucket: $BACKEND_BUCKET"
            echo "   ðŸ—„ï¸ DynamoDB Table: $BACKEND_TABLE"
            
            echo "backend_bucket=$BACKEND_BUCKET" >> $GITHUB_OUTPUT
            echo "backend_table=$BACKEND_TABLE" >> $GITHUB_OUTPUT
          else
            echo "âŒ Backend configuration not found in Parameter Store"
            echo "   This could mean:"
            echo "   1. No infrastructure was deployed for environment: ${{ github.event.inputs.environment }}"
            echo "   2. The deployment failed before storing backend config"
            echo "   3. The backend was already cleaned up"
            
            # Try to find any existing buckets with our naming pattern
            echo "ðŸ” Searching for existing terraform state buckets..."
            aws s3api list-buckets --query 'Buckets[?starts_with(Name, `terraform-state-vpn-`)].Name' --output text
            
            exit 1
          fi

      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: ðŸš€ Terraform Init with Remote Backend
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ steps.get_backend.outputs.backend_bucket }}" \
            -backend-config="key=vpn-${{ github.event.inputs.environment }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ steps.get_backend.outputs.backend_table }}"

      - name: ðŸ“‹ Terraform Plan (Destroy)
        working-directory: ./terraform
        run: |
          # Get SSH public key from Parameter Store and pass as variable
          SSH_PUBLIC_KEY=$(aws ssm get-parameter \
            --name "/vpn/${{ github.event.inputs.environment }}/ssh-public-key" \
            --query 'Parameter.Value' \
            --output text)
          
          export TF_VAR_environment="${{ github.event.inputs.environment }}"
          export TF_VAR_ssh_public_key="$SSH_PUBLIC_KEY"
          terraform plan -destroy -out=destroy-plan

      - name: ðŸ—‘ï¸ Terraform Destroy
        working-directory: ./terraform
        run: |
          # Get SSH public key from Parameter Store and pass as variable
          SSH_PUBLIC_KEY=$(aws ssm get-parameter \
            --name "/vpn/${{ github.event.inputs.environment }}/ssh-public-key" \
            --query 'Parameter.Value' \
            --output text)
          
          export TF_VAR_environment="${{ github.event.inputs.environment }}"
          export TF_VAR_ssh_public_key="$SSH_PUBLIC_KEY"
          terraform apply -auto-approve destroy-plan

      - name: ðŸ§¹ Cleanup Parameter Store
        run: |
          echo "ðŸ§¹ Cleaning up Parameter Store entries..."
          
          # List all parameters for this environment
          PARAMETERS=$(aws ssm get-parameters-by-path \
            --path "/vpn/${{ github.event.inputs.environment }}" \
            --query 'Parameters[].Name' \
            --output text)
          
          if [ -n "$PARAMETERS" ]; then
            echo "Found parameters to delete: $PARAMETERS"
            for param in $PARAMETERS; do
              echo "Deleting parameter: $param"
              aws ssm delete-parameter --name "$param" || echo "Failed to delete $param"
            done
          else
            echo "No parameters found to delete"
          fi

      - name: ðŸ§¹ Cleanup Terraform State (Optional)
        run: |
          echo "ðŸ§¹ Optionally cleaning up Terraform state..."
          echo "âš ï¸  NOTE: This will delete the state file. Only do this if you're sure."
          echo "   State file location: s3://${{ steps.get_backend.outputs.backend_bucket }}/vpn-${{ github.event.inputs.environment }}/terraform.tfstate"
          
          # Remove the specific state file for this environment
          aws s3 rm "s3://${{ steps.get_backend.outputs.backend_bucket }}/vpn-${{ github.event.inputs.environment }}/terraform.tfstate" || echo "State file not found or already deleted"
          
          # Check if this was the last environment using this backend
          REMAINING_STATES=$(aws s3 ls "s3://${{ steps.get_backend.outputs.backend_bucket }}/vpn-" | wc -l)
          if [ "$REMAINING_STATES" -eq 0 ]; then
            echo "ðŸ’¡ This was the last environment. You may want to clean up the backend infrastructure:"
            echo "   S3 Bucket: ${{ steps.get_backend.outputs.backend_bucket }}"
            echo "   DynamoDB Table: ${{ steps.get_backend.outputs.backend_table }}"
            echo "   (These are kept to avoid affecting other environments)"
          fi

      - name: âœ… Destruction Complete
        run: |
          echo "ðŸŽ‰ Infrastructure destroyed successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŒ Environment: ${{ github.event.inputs.environment }}"
          echo "ðŸ—‘ï¸  Status: DESTROYED"
          echo "ðŸ’° Cost: $0 (no resources running)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… What was cleaned up:"
          echo "  â€¢ EC2 instance"
          echo "  â€¢ VPC and networking"
          echo "  â€¢ Security groups"
          echo "  â€¢ SSH key pairs"
          echo "  â€¢ Parameter Store entries"
          echo "  â€¢ Terraform state file"
          echo ""
          echo "ðŸ’¡ The backend infrastructure (S3 + DynamoDB) is preserved"
          echo "   for future deployments and other environments."

      - name: ðŸ“Š Create Destruction Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ—‘ï¸ VPN Infrastructure Destroyed
          
          ## âœ… Destruction Complete
          - **Environment**: ${{ github.event.inputs.environment }}
          - **Status**: All resources successfully destroyed
          - **Cost Impact**: No longer incurring charges
          
          ## ðŸ“‹ Resources Destroyed
          - EC2 Instance (WireGuard server)
          - VPC and networking components
          - Security Groups
          - SSH Key Pairs
          - Parameter Store entries
          - Terraform state file
          
          ## ðŸ”„ Next Steps
          - You can redeploy anytime using the **"Deploy VPN Infrastructure"** workflow
          - All configurations will be freshly generated on next deployment
          - Remember to download new client configs after redeployment
          
          ## ðŸ’¡ Tips
          - Consider saving your WireGuard client configurations locally
          - Document any custom settings for future deployments
          - The backend infrastructure (S3 + DynamoDB) is preserved for efficiency
          EOF
