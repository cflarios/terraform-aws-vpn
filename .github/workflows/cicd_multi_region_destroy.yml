name: üóëÔ∏è Destroy Multi-Region VPN Network

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'multi-region'
        type: string
      regions:
        description: 'AWS regions to destroy (comma-separated, or "all" for all deployed regions)'
        required: true
        default: 'all'
        type: string
      confirmation:
        description: 'Type DESTROY-ALL to confirm multi-region destruction'
        required: true
        type: string

jobs:
  validate-and-discover:
    name: ‚úÖ Validate and Discover Deployments
    runs-on: ubuntu-latest
    
    outputs:
      regions_matrix: ${{ steps.discover_regions.outputs.regions_matrix }}
      regions_list: ${{ steps.discover_regions.outputs.regions_list }}
      total_regions: ${{ steps.discover_regions.outputs.total_regions }}
      
    steps:
      - name: ‚úã Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DESTROY-ALL" ]; then
            echo "‚ùå ERROR: You must type exactly 'DESTROY-ALL' to confirm multi-region destruction"
            echo "   You typed: '${{ github.event.inputs.confirmation }}'"
            echo "   This will destroy VPN servers in multiple regions!"
            exit 1
          fi
          echo "‚úÖ Confirmation validated for multi-region destruction"

      - name: üîß Configure AWS Credentials (us-east-1 for discovery)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: üîç Discover Deployed Regions
        id: discover_regions
        run: |
          echo "üîç Discovering deployed regions for environment: ${{ github.event.inputs.environment }}"
          
          REGIONS_INPUT="${{ github.event.inputs.regions }}"
          ALL_POSSIBLE_REGIONS=("us-east-1" "us-east-2" "us-west-1" "us-west-2" "eu-west-1" "eu-west-2" "eu-central-1" "ap-southeast-1" "ap-southeast-2" "ap-northeast-1")
          
          DEPLOYED_REGIONS=()
          
          if [ "$REGIONS_INPUT" = "all" ]; then
            echo "üåç Checking all possible regions for deployed infrastructure..."
            
            for region in "${ALL_POSSIBLE_REGIONS[@]}"; do
              echo "üîç Checking region: $region"
              
              # Check if backend bucket exists for this region
              if aws ssm get-parameter \
                --name "/vpn/${{ github.event.inputs.environment }}/$region/backend-bucket" \
                --region $region 2>/dev/null >/dev/null; then
                
                # Verify instance IP exists too
                if aws ssm get-parameter \
                  --name "/vpn/${{ github.event.inputs.environment }}/$region/instance-ip" \
                  --region $region 2>/dev/null >/dev/null; then
                  
                  DEPLOYED_REGIONS+=("$region")
                  echo "‚úÖ Found deployment in: $region"
                else
                  echo "‚ö†Ô∏è  Found backend but no instance in: $region"
                fi
              else
                echo "‚ÑπÔ∏è  No deployment found in: $region"
              fi
            done
          else
            echo "üìã Using specified regions: $REGIONS_INPUT"
            
            # Parse comma-separated regions
            REGIONS_CLEAN=$(echo "$REGIONS_INPUT" | tr -d ' ')
            IFS=',' read -ra REGIONS_ARRAY <<< "$REGIONS_CLEAN"
            
            for region in "${REGIONS_ARRAY[@]}"; do
              # Validate region
              if [[ " ${ALL_POSSIBLE_REGIONS[@]} " =~ " ${region} " ]]; then
                # Check if deployment exists
                if aws ssm get-parameter \
                  --name "/vpn/${{ github.event.inputs.environment }}/$region/backend-bucket" \
                  --region $region 2>/dev/null >/dev/null; then
                  
                  DEPLOYED_REGIONS+=("$region")
                  echo "‚úÖ Found deployment in: $region"
                else
                  echo "‚ùå No deployment found in specified region: $region"
                  echo "    Skipping this region..."
                fi
              else
                echo "‚ùå Invalid region: $region"
                exit 1
              fi
            done
          fi
          
          if [ ${#DEPLOYED_REGIONS[@]} -eq 0 ]; then
            echo "‚ùå No deployed infrastructure found for environment: ${{ github.event.inputs.environment }}"
            echo "    Either the environment doesn't exist or all resources have already been destroyed."
            exit 1
          fi
          
          echo ""
          echo "üéØ Found ${#DEPLOYED_REGIONS[@]} deployed regions:"
          for region in "${DEPLOYED_REGIONS[@]}"; do
            echo "  üåç $region"
          done
          
          # Create matrix for parallel jobs
          MATRIX_JSON=$(printf '%s\n' "${DEPLOYED_REGIONS[@]}" | jq -R -s -c 'split("\n")[:-1] | map({region: .})')
          echo "regions_matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          
          # Create comma-separated list
          REGIONS_LIST=$(printf '%s,' "${DEPLOYED_REGIONS[@]}")
          REGIONS_LIST=${REGIONS_LIST%,}  # Remove trailing comma
          echo "regions_list=$REGIONS_LIST" >> $GITHUB_OUTPUT
          echo "total_regions=${#DEPLOYED_REGIONS[@]}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "üóëÔ∏è  Will destroy infrastructure in: $REGIONS_LIST"
          echo "‚ö†Ô∏è  This action cannot be undone!"

  destroy-multi-region:
    name: üóëÔ∏è Destroy in ${{ matrix.region }}
    runs-on: ubuntu-latest
    needs: validate-and-discover
    
    strategy:
      matrix:
        include: ${{ fromJson(needs.validate-and-discover.outputs.regions_matrix) }}
      max-parallel: 3  # Destroy max 3 regions simultaneously
      fail-fast: false  # Continue with other regions even if one fails
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîß Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ matrix.region }}

      - name: üîç Get Backend Configuration
        id: get_backend
        run: |
          echo "üîç Getting backend configuration for ${{ matrix.region }}..."
          
          BUCKET_NAME=$(aws ssm get-parameter \
            --name "/vpn/${{ github.event.inputs.environment }}/${{ matrix.region }}/backend-bucket" \
            --query 'Parameter.Value' \
            --output text)
          
          TABLE_NAME=$(aws ssm get-parameter \
            --name "/vpn/${{ github.event.inputs.environment }}/${{ matrix.region }}/backend-table" \
            --query 'Parameter.Value' \
            --output text)
          
          echo "backend_bucket=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "backend_table=$TABLE_NAME" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Backend configuration for ${{ matrix.region }}:"
          echo "   ü™£ S3 Bucket: $BUCKET_NAME"
          echo "   üóÑÔ∏è DynamoDB Table: $TABLE_NAME"

      - name: üîë Get SSH Keys
        run: |
          echo "üîë Retrieving SSH keys for ${{ matrix.region }}..."
          mkdir -p ~/.ssh
          
          # Get private key
          aws ssm get-parameter \
            --name "/vpn/${{ github.event.inputs.environment }}/${{ matrix.region }}/ssh-private-key" \
            --with-decryption \
            --query 'Parameter.Value' \
            --output text > ~/.ssh/vpn-server-key-${{ matrix.region }}
          
          chmod 600 ~/.ssh/vpn-server-key-${{ matrix.region }}
          echo "‚úÖ SSH keys retrieved for ${{ matrix.region }}"

      - name: üèóÔ∏è Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: üöÄ Initialize Terraform
        working-directory: ./terraform
        run: |
          echo "üöÄ Initializing Terraform for ${{ matrix.region }}..."
          
          terraform init \
            -backend-config="bucket=${{ steps.get_backend.outputs.backend_bucket }}" \
            -backend-config="key=vpn-${{ github.event.inputs.environment }}-${{ matrix.region }}/terraform.tfstate" \
            -backend-config="region=${{ matrix.region }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ steps.get_backend.outputs.backend_table }}"

      - name: üîç Debug Terraform State
        working-directory: ./terraform
        run: |
          echo "üîç Debugging Terraform state for ${{ matrix.region }}..."
          
          # Set variables
          export TF_VAR_aws_region="${{ matrix.region }}"
          export TF_VAR_environment="${{ github.event.inputs.environment }}"
          
          # Check what resources Terraform thinks exist
          echo "üìã Current Terraform state:"
          terraform show || echo "No state found or state is empty"
          
          echo ""
          echo "üìã Resources in state:"
          terraform state list || echo "No resources in state"

      - name: üóëÔ∏è Terraform Destroy
        working-directory: ./terraform
        run: |
          echo "üóëÔ∏è Destroying infrastructure in ${{ matrix.region }}..."
          
          # Set region variable
          export TF_VAR_aws_region="${{ matrix.region }}"
          export TF_VAR_environment="${{ github.event.inputs.environment }}"
          
          # Try to destroy
          if terraform destroy -auto-approve; then
            echo "‚úÖ Infrastructure successfully destroyed in ${{ matrix.region }}"
          else
            echo "‚ö†Ô∏è  Terraform destroy had issues in ${{ matrix.region }}, but continuing with cleanup..."
          fi

      - name: üßπ Clean Up Backend Resources
        run: |
          echo "üßπ Cleaning up backend resources for ${{ matrix.region }}..."
          
          BUCKET_NAME="${{ steps.get_backend.outputs.backend_bucket }}"
          TABLE_NAME="${{ steps.get_backend.outputs.backend_table }}"
          
          # Remove all objects from S3 bucket (including versions)
          echo "üóëÔ∏è  Emptying S3 bucket: $BUCKET_NAME"
          aws s3 rm "s3://$BUCKET_NAME" --recursive || echo "Bucket might be empty"
          
          # Delete all object versions
          aws s3api list-object-versions --bucket "$BUCKET_NAME" --query 'Versions[].{Key:Key,VersionId:VersionId}' --output text | while read key version; do
            if [ ! -z "$key" ]; then
              aws s3api delete-object --bucket "$BUCKET_NAME" --key "$key" --version-id "$version" || true
            fi
          done
          
          # Delete all delete markers
          aws s3api list-object-versions --bucket "$BUCKET_NAME" --query 'DeleteMarkers[].{Key:Key,VersionId:VersionId}' --output text | while read key version; do
            if [ ! -z "$key" ]; then
              aws s3api delete-object --bucket "$BUCKET_NAME" --key "$key" --version-id "$version" || true
            fi
          done
          
          # Delete S3 bucket
          echo "üóëÔ∏è  Deleting S3 bucket: $BUCKET_NAME"
          aws s3api delete-bucket --bucket "$BUCKET_NAME" || echo "Bucket might already be deleted"
          
          # Delete DynamoDB table
          echo "üóëÔ∏è  Deleting DynamoDB table: $TABLE_NAME"
          aws dynamodb delete-table --table-name "$TABLE_NAME" || echo "Table might already be deleted"
          
          echo "‚úÖ Backend resources cleaned up for ${{ matrix.region }}"

      - name: üßπ Clean Up Parameter Store
        run: |
          echo "üßπ Cleaning up Parameter Store entries for ${{ matrix.region }}..."
          
          # List of parameters to delete
          PARAMETERS=(
            "/vpn/${{ github.event.inputs.environment }}/${{ matrix.region }}/backend-bucket"
            "/vpn/${{ github.event.inputs.environment }}/${{ matrix.region }}/backend-table"
            "/vpn/${{ github.event.inputs.environment }}/${{ matrix.region }}/ssh-private-key"
            "/vpn/${{ github.event.inputs.environment }}/${{ matrix.region }}/ssh-public-key"
            "/vpn/${{ github.event.inputs.environment }}/${{ matrix.region }}/instance-ip"
          )
          
          for param in "${PARAMETERS[@]}"; do
            echo "üóëÔ∏è  Deleting parameter: $param"
            aws ssm delete-parameter --name "$param" || echo "Parameter might not exist: $param"
          done
          
          echo "‚úÖ Parameter Store cleaned up for ${{ matrix.region }}"

      - name: ‚úÖ Region Destruction Complete
        run: |
          echo "üéâ Successfully destroyed all infrastructure in ${{ matrix.region }}!"
          echo "‚úÖ All resources have been cleaned up"
          echo "üí∞ No more costs will be incurred for this region"

  create-destruction-summary:
    name: üìä Create Destruction Summary
    runs-on: ubuntu-latest
    needs: [validate-and-discover, destroy-multi-region]
    if: always()  # Run even if some destructions failed
    
    steps:
      - name: üìä Create Destruction Summary
        run: |
          echo "üóëÔ∏è Multi-Region VPN Destruction Summary"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üåç Environment: ${{ github.event.inputs.environment }}"
          echo "üìã Regions processed: ${{ needs.validate-and-discover.outputs.regions_list }}"
          echo "üî¢ Total regions: ${{ needs.validate-and-discover.outputs.total_regions }}"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      - name: üìã Create GitHub Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # üóëÔ∏è Multi-Region VPN Destruction Complete!
          
          ## üìä Destruction Summary
          - **Environment**: ${{ github.event.inputs.environment }}
          - **Regions Destroyed**: ${{ needs.validate-and-discover.outputs.regions_list }}
          - **Total Regions**: ${{ needs.validate-and-discover.outputs.total_regions }}
          
          ## ‚úÖ Cleanup Actions Performed
          
          For each region, the following resources were destroyed:
          
          ### üèóÔ∏è Infrastructure Resources
          - ‚úÖ EC2 instances
          - ‚úÖ VPC and networking components
          - ‚úÖ Security groups
          - ‚úÖ SSH key pairs
          
          ### üóÑÔ∏è Backend Resources
          - ‚úÖ S3 buckets (including all versions)
          - ‚úÖ DynamoDB tables
          - ‚úÖ Backend state files
          
          ### üîê Configuration Data
          - ‚úÖ SSH keys from Parameter Store
          - ‚úÖ Instance IP addresses
          - ‚úÖ Backend configuration parameters
          
          ## üí∞ Cost Impact
          - **All AWS resources destroyed** - no more costs will be incurred
          - **Multi-region deployment completely cleaned up**
          - **All state and configuration data removed**
          
          ## üîÑ Next Steps
          If you want to deploy a new multi-region VPN network:
          1. Use the **"Deploy Multi-Region VPN Network"** workflow
          2. Select your desired regions
          3. Configure instance types and peer counts
          4. Everything will be set up fresh with new resources
          
          EOF

      - name: üéâ Final Success Message
        run: |
          echo "üéä Multi-Region VPN Network Destruction Complete!"
          echo "‚úÖ All infrastructure across ${{ needs.validate-and-discover.outputs.total_regions }} regions has been destroyed"
          echo "üí∞ No more costs will be incurred"
          echo "üßπ All resources, state, and configuration data have been cleaned up"
